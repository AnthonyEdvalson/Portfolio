<!DOCTYPE html>
<html class="black" lang="en">
    <!--

         _      _     _                            _
        | |    | |___| | ___ ___  _ __ ___   ___  | | 
        | | /\ | | _ \ |/ __/ _ \| '_ ` _ \ / _ \ | |
         \ V  V /  __/ | (_| (_) | | | | | |  __/ |_|
          \_/\_/ \___|_|\___\___/|_| |_| |_|\___| (_)

        I've hidden a few easter eggs on the site, let me know if you find them all!

        Stay awesome :)

    -->
    <head>
        <meta charset="UTF-8">
        <title>Tony Edvalson</title>
        <meta name="description" content="Tony Edvalson's personal website">
        <meta name="author" content="Tony Edvalson">
        <meta name="copyright" content="Tony Edvalson">
        <meta name="keywords" content="Tony Edvalson, software engineer, machine learning, personal website, projects, portfolio">
        <meta name="theme-color" content="#0a0a0a" id="theme-color">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <!-- Google tag (gtag.js) -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-M50JEYPFZE"></script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
    
            gtag('config', 'G-M50JEYPFZE');
        </script> 

        <link rel="stylesheet" href="site.css">
        <link rel="icon" href="favicon/fav-black.png" type="image/png" id="favicon">
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preonnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

        <script>
            window.onload = function() {
                let name = new URLSearchParams(window.location.search).get("hello");
                if (name) {
                    const hello = document.getElementById('hello');
                    hello.innerText = `Hello, ${name}!`;
                }

                // Gotta protect my email from those pesky bots
                let parts = [
                    "dG9ueWVkdmF",
                    "sc29uQGdtYW",
                    "lsLmNvbQ=="
                ];
                let value = atob(parts.join(''));
                let e = document.getElementsByClassName("em");
                for (let i = 0; i < e.length; i++) {
                    e[i].innerText = value;
                    e[i].href = `mailto:${value}`;
                    // e[i].addEventListener("click", () => {
                    //     navigator.clipboard.writeText(value);
                    // });
                }
            }
        

            function setTheme(themeName) {
                if (themeName !== "rainbow") {
                    localStorage.setItem('theme', themeName);
                }
                document.documentElement.className = themeName;
                document.getElementById('favicon').href = `favicon/fav-${themeName}.png`;
                document.getElementById('theme-color').content = getComputedStyle(document.documentElement).getPropertyValue("--base");
            }

            window.addEventListener('load', () => {
                let theme = localStorage.getItem('theme') || "black";
                setTheme(theme);
            });
        </script>
        <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    </head>
    <body>
        <div class="grid-bg"></div>
        
        <div id="screensaver-canvas-container" style="display: none;">
            <canvas id="screensaver-canvas-webgl"></canvas>
            <canvas id="screensaver-canvas-2d" style="pointer-events: none"></canvas>
        </div>
        <div id="grid"></div>

        <div id="modal" class="modal" hidden>
            <div class="modal__phantom"></div>
            <button class="modal__close" aria-label="Close">&times;</button>
            <div class="modal__content">
                <span class="modal__code"></span>
                <span class="modal__category"></span>
                <h1 class="modal__title"></h1>
                <p class="modal__subtitle"></p>
                <div class="modal__body markdown"></div>
            </div>
        </div>
        
        <!-- Miscellenous scripts, the stuff down here is for things that shouldn't block the rendering of the page -->
        <script>
            console.log("Yahaha! You found me! ðŸŒ±")
        </script>
        <script src="grid-data.js"></script>
        <script>
            function renderItemMarkdown(markdown) {
                const renderer = new marked.Renderer();

                renderer.link = ({href, title, text}) => {
                    let html = `<a href="${href}"`;
                    if (title) {
                        html += ` title="${title}"`;
                    }
                    html += ` target="_blank">${text}</a>`;
                    return html;
                };

                renderer.image = ({href, title, text}) => {
                    if (href.endsWith(".html")) {
                        // This is an embed, use an iframe
                        return `<iframe src="${href}" width="100%" height="100%" frameborder="0" allowtransparency="true"></iframe>`;
                    }
                    let html = `<img src="${href}"`;
                    if (title) {
                        html += ` title="${title}"`;
                    }
                    html += ` alt="${text}">`;
                    return html;
                };

                marked.use({ renderer });

                var bodyHtml;
                if (window.marked && window.marked.parse) {
                    bodyHtml = window.marked.parse(markdown);
                } else if (window.marked) {
                    bodyHtml = window.marked(markdown);
                }
                return bodyHtml;
            }

            function populateGrid(gridData) {
                if (!gridData || !gridData.length) return;

                gridData.sort(function (a, b) {
                    return a.order - b.order;
                });

                var grid = document.getElementById("grid");
                if (!grid) return;

                for (var i = 0; i < gridData.length; i++) {
                    var item = gridData[i];

                    var isClickable = !item.contentInGrid && item.markdown;

                    var classes = ["tile"];
                    classes.push(`col-span-${item.width}`);
                    classes.push(`row-span-${item.height}`);
                    classes.push(`tile--${item.color}`);
                    if (item.extraClass) {
                        classes.push(`tile--${item.extraClass}`);
                    }
                    if (isClickable) {
                        classes.push("tile--clickable");
                    }

                    var tile = document.createElement("div");
                    tile.className = classes.join(" ");

                    if (item.chip) {
                        var chipEl = document.createElement("iframe");
                        chipEl.className = "tile__chip";
                        chipEl.src = `chips/${item.chip}.html`;
                        chipEl.width = "100%";
                        chipEl.height = "100%";
                        chipEl.frameBorder = "0";
                        chipEl.setAttribute("allowtransparency", "true");
                        tile.appendChild(chipEl);

                        (function(iframe, tileEl) {
                            tileEl.addEventListener("mouseenter", function() {
                                if (iframe.contentWindow) {
                                    iframe.contentWindow.postMessage({ type: "hover", value: true }, "*");
                                }
                            });
                            tileEl.addEventListener("mouseleave", function() {
                                if (iframe.contentWindow) {
                                    iframe.contentWindow.postMessage({ type: "hover", value: false }, "*");
                                }
                            });
                            tileEl.addEventListener("mousemove", function(e) {
                                if (iframe.contentWindow) {
                                    var rect = tileEl.getBoundingClientRect();
                                    var x = (e.clientX - rect.left) / rect.width;
                                    var y = (e.clientY - rect.top) / rect.height;
                                    iframe.contentWindow.postMessage({ type: "mousemove", x: x, y: y }, "*");
                                }
                            });
                        })(chipEl, tile);
                    }

                    const contentEl = document.createElement("div");
                    contentEl.className = "tile__content";

                    let anyContent = false;
                    if (item.code) {
                        var codeEl = document.createElement("span");
                        codeEl.className = "tile__code";
                        codeEl.textContent = item.code;
                        contentEl.appendChild(codeEl);
                        anyContent = true;
                    }

                    if (item.category) {
                        var labelEl = document.createElement("span");
                        labelEl.className = "tile__label";
                        labelEl.textContent = item.category.toUpperCase();
                        contentEl.appendChild(labelEl);
                        anyContent = true;
                    }

                    if (item.title) {
                        var titleEl = document.createElement("h2");
                        titleEl.innerHTML = item.title.toUpperCase().replace("\n", "<br>");
                        contentEl.appendChild(titleEl);
                        anyContent = true;
                    }

                    if (item.subtitle) {
                        var subtitleEl = document.createElement("p");
                        subtitleEl.textContent = item.subtitle;
                        contentEl.appendChild(subtitleEl);
                        anyContent = true;
                    }

                    if (anyContent) {
                        tile.appendChild(contentEl);
                    }

                    if (item.contentInGrid && item.markdown) {
                        var markdownEl = document.createElement("div");
                        markdownEl.className = "markdown";
                        markdownEl.innerHTML = renderItemMarkdown(item.markdown);
                        tile.appendChild(markdownEl);
                    }

                    if (isClickable) {
                        (function(itemData, tileEl) {
                            tileEl.addEventListener("click", function(e) {
                                openModal(itemData, tileEl);
                            });
                        })(item, tile);
                    }

                    grid.appendChild(tile);
                }
            }

            if (typeof GRID_DATA !== "undefined") {
                populateGrid(GRID_DATA);
            } else {
                console.error("GRID_DATA is not defined. Run build-grid.js to generate grid-data.js.");
            }

            var modal = document.getElementById("modal");
            var modalPhantom = modal.querySelector(".modal__phantom");
            var modalClose = modal.querySelector(".modal__close");
            var modalContent = modal.querySelector(".modal__content");
            var modalCode = modal.querySelector(".modal__code");
            var modalCategory = modal.querySelector(".modal__category");
            var modalTitle = modal.querySelector(".modal__title");
            var modalSubtitle = modal.querySelector(".modal__subtitle");
            var modalBody = modal.querySelector(".modal__body");

            function findItemByCode(code) {
                if (!code || typeof GRID_DATA === "undefined") return null;
                for (var i = 0; i < GRID_DATA.length; i++) {
                    if (GRID_DATA[i].code === code) return GRID_DATA[i];
                }
                return null;
            }

            function openModal(item, tileEl) {
                modal.classList.remove("modal--black", "modal--orange", "modal--white");
                modal.classList.add("modal--" + (item.color || "black"));

                if (tileEl) {
                    var rect = tileEl.getBoundingClientRect();
                    modalPhantom.style.transition = "none";
                    modalPhantom.style.top = rect.top + "px";
                    modalPhantom.style.left = rect.left + "px";
                    modalPhantom.style.width = rect.width + "px";
                    modalPhantom.style.height = rect.height + "px";
                } else {
                    modalPhantom.style.transition = "none";
                    modalPhantom.style.top = "50%";
                    modalPhantom.style.left = "50%";
                    modalPhantom.style.width = "0";
                    modalPhantom.style.height = "0";
                }
                
                modalContent.style.opacity = "0";
                modalClose.style.opacity = "0";

                modalCode.textContent = item.code || "";
                modalCode.style.display = item.code ? "" : "none";

                modalCategory.textContent = item.category ? item.category.toUpperCase() : "";
                modalCategory.style.display = item.category ? "" : "none";

                modalTitle.innerHTML = item.title ? item.title.toUpperCase().replace("\n", "<br>") : "";
                modalTitle.style.display = item.title ? "" : "none";

                modalSubtitle.textContent = item.subtitle || "";
                modalSubtitle.style.display = item.subtitle ? "" : "none";

                modalBody.innerHTML = item.markdown ? renderItemMarkdown(item.markdown) : "";
                modalBody.style.display = item.markdown ? "" : "none";

                modal.hidden = false;
                modal.scrollTop = 0;
                document.body.style.overflow = "hidden";

                if (item.code) {
                    window.location.hash = encodeURIComponent(item.code);
                }

                requestAnimationFrame(function() {
                    requestAnimationFrame(function() {
                        modalPhantom.style.transition = "all 0.35s cubic-bezier(0.4, 0, 0.2, 1)";
                        modalPhantom.style.top = "0";
                        modalPhantom.style.left = "0";
                        modalPhantom.style.width = "100%";
                        modalPhantom.style.height = "100%";
                    });
                });

                setTimeout(function() {
                    modal.classList.add("modal--expanded");
                    modalContent.style.transition = "opacity 0.2s ease";
                    modalContent.style.opacity = "1";
                    modalClose.style.transition = "opacity 0.2s ease";
                    modalClose.style.opacity = "1";
                }, 280);
            }

            function closeModal() {
                modal.hidden = true;
                modal.classList.remove("modal--expanded");
                modalBody.innerHTML = "";
                document.body.style.overflow = "";
                window.location.hash = "";
            }

            var hash = window.location.hash;
            if (hash && hash.length > 1) {
                var code = decodeURIComponent(hash.substring(1));
                var item = findItemByCode(code);
                if (item) {
                    openModal(item, null);
                }
            }

            modalClose.addEventListener("click", closeModal);

            modal.addEventListener("click", function(e) {
                if (e.target === modal) {
                    closeModal();
                }
            });

            document.addEventListener("keydown", function(e) {
                if (e.key === "Escape" && !modal.hidden) {
                    closeModal();
                }
            });
        </script>
    </body>
</html>
